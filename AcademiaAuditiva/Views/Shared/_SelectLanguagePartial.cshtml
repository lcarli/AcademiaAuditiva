@using Microsoft.AspNetCore.Builder
@using Microsoft.AspNetCore.Http.Features
@using Microsoft.AspNetCore.Localization
@using Microsoft.AspNetCore.Mvc.Localization
@using Microsoft.Extensions.Options
@inject IOptions<RequestLocalizationOptions> LocOptions

@{
#pragma warning disable CS8602
    var requestCulture = Context.Features.Get<IRequestCultureFeature>();
    var currentCulture = requestCulture.RequestCulture.UICulture.Name;
    var returnUrl = string.IsNullOrEmpty(Context.Request.Path) ? "~/" : $"~{Context.Request.Path.Value}";

    var cultureItems = LocOptions.Value.SupportedUICultures
        .Select(c => new SelectListItem { Value = c.Name, Text = c.NativeName })
        .ToList();

    var currentFlag = currentCulture.Substring(currentCulture.LastIndexOf('-') + 1);
#pragma warning restore CS8602
}

<form id="selectLanguage" asp-controller="Dashboard" asp-action="SetLanguage" asp-route-returnUrl="@returnUrl" method="post">
    <div class="dropdown dropup">
        <button class="btn btn-link dropdown-toggle p-0 border-0" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            <img src="~/images/@(currentFlag)-icon.webp" alt="@currentCulture" width="30" height="20" class="flag-icon" />
        </button>
        <ul class="dropdown-menu dropdown-menu-end shadow-sm">
            @foreach (var item in cultureItems)
            {
                var code = item.Value;
                var flag = code.Substring(code.LastIndexOf('-') + 1);
                <li>
                    <a class="dropdown-item d-flex align-items-center gap-2" href="#"
                       onclick="event.preventDefault(); document.getElementById('culture').value='@code'; document.getElementById('selectLanguage').submit();">
                        <img src="~/images/@(flag)-icon.webp" alt="@item.Text" width="24" height="16" class="flag-icon" />
                        @item.Text
                    </a>
                </li>
            }
        </ul>
    </div>
    <input type="hidden" id="culture" name="culture" value="@currentCulture" />
</form>